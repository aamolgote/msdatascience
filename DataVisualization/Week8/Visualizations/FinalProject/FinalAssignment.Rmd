---
title: "FinalAssignment"
author: "Amol Gote"
date: "3/7/2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2) 
library(readr) 
library(gridExtra)
library(tidyverse)
library(sf)
library(maps)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r final_project_data_load, message=FALSE}
lendingClubLoanData <- read.csv("data/lending_club_loan_data.csv")
lendingClubLoanData <- lendingClubLoanData[, !(colnames(lendingClubLoanData) %in% c("id","member_id", "url", "desc"))]
lendingClubLoanData <- lendingClubLoanData[, !(colnames(lendingClubLoanData) %in% c("open_acc_6m", "open_act_il", "open_il_12m", "open_il_24m", "mths_since_rcnt_il", "total_bal_il", "il_util", "open_rv_12m", "open_rv_24m", "max_bal_bc", "all_util", "total_rev_hi_lim", "inq_fi", "total_cu_tl", "acc_open_past_24mths", "bc_open_to_buy", "bc_util", "mo_sin_old_il_acct", "mo_sin_old_rev_tl_op", "mo_sin_rcnt_rev_tl_op", "mo_sin_rcnt_tl", "mths_since_recent_bc", "mths_since_recent_bc_dlq", "mths_since_recent_inq", "mths_since_recent_revol_delinq", "num_accts_ever_120_pd", "num_actv_bc_tl", "num_actv_rev_tl", "num_bc_sats", "num_bc_tl", "num_il_tl", "num_op_rev_tl", "num_rev_accts", "num_rev_tl_bal_gt_0", "num_sats", "pct_tl_nvr_dlq", "percent_bc_gt_75", "tot_hi_cred_lim", "total_bal_ex_mort", "total_bc_limit", "total_il_high_credit_limit", "revol_bal_joint", "sec_app_earliest_cr_line", "sec_app_inq_last_6mths", "sec_app_mort_acc", "sec_app_open_acc", "sec_app_revol_util", "sec_app_open_act_il", "sec_app_num_rev_accts", "sec_app_chargeoff_within_12_mths", "sec_app_collections_12_mths_ex_med", "sec_app_mths_since_last_major_derog", "hardship_reason", "hardship_status", "deferral_term", "hardship_amount", "hardship_start_date", "hardship_end_date", "payment_plan_start_date", "hardship_length", "hardship_dpd", "hardship_loan_status", "orig_projected_additional_accrued_interest", "hardship_payoff_balance_amount", "hardship_last_payment_amount", "disbursement_method", "debt_settlement_flag", "debt_settlement_flag_date", "settlement_status", "settlement_date", "settlement_amount", "settlement_percentage", "settlement_term"))]
lendingClubLoanData <- lendingClubLoanData[, !(colnames(lendingClubLoanData) %in% c("earliest_cr_line","inq_last_6mths","mths_since_last_delinq","mths_since_last_record","open_acc","pub_rec","revol_bal","revol_util","total_acc","initial_list_status","out_prncp","out_prncp_inv","total_pymnt","total_pymnt_inv","total_rec_prncp","total_rec_int","total_rec_late_fee","recoveries","collection_recovery_fee","last_pymnt_d","last_pymnt_amnt","next_pymnt_d","last_credit_pull_d","collections_12_mths_ex_med","mths_since_last_major_derog","policy_code","acc_now_delinq","tot_coll_amt","tot_cur_bal","inq_last_12m","avg_cur_bal","chargeoff_within_12_mths","delinq_amnt","mort_acc","num_tl_120dpd_2m","num_tl_30dpd","num_tl_90g_dpd_24m","num_tl_op_past_12m"))]
lendingClubLoanData$orig_year<-substr(lendingClubLoanData$issue_d,5,8)
write.csv(lendingClubLoanData, file = "data/lending_club_loan_data_final.csv", row.names=FALSE)
lendingClubLoanData <- read.csv("data/lending_club_loan_data_final.csv")
```

```{r}
numberOfLoansByYear <- lendingClubLoanData %>% 
  group_by(orig_year)%>%
  summarise(loanCountByYear=n())

ggplot(data = numberOfLoansByYear)+
  geom_line(color="steelblue", size=1.2, aes(x=orig_year,y=loanCountByYear))+
  geom_point(color="steelblue", size=2.5, aes(x=orig_year,y=loanCountByYear))+
  scale_x_continuous(breaks = numberOfLoansByYear$orig_year) +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(x="Year",y="# Number of loans",title="Loans processed in each Year")+
  theme_minimal() 
```

```{r}
totalFundedAMountPerYear <- lendingClubLoanData %>% 
  group_by(orig_year)%>%
  summarise(totalFundedAmount= sum(as.numeric(funded_amnt)))

ggplot(data = totalFundedAMountPerYear, aes(x=orig_year, y=totalFundedAmount)) +
  geom_bar(stat="identity", width=0.5, fill = "steelblue") +
  scale_x_continuous(breaks = numberOfLoansByYear$orig_year) +
  scale_y_continuous(labels = scales::dollar) +
  labs(x = "Year", y = "$ Total funded loan",title="Total Funded Loan Amount each Year") +
  theme_minimal() 
```

```{r}
lendingClubLoanData %>%
ggplot() +
  geom_boxplot(aes(x=term, y=funded_amnt, color=term)) + 
  scale_y_continuous(labels = scales::dollar) +
  labs(x = "Term", y = "Loan Funded Amount", title="Loan Amount and term relation") +
  theme_minimal() 
```



```{r}

filteredLendingClubData <- lendingClubLoanData %>%
  drop_na(annual_inc)

filteredLendingClubData <- filteredLeningClubData %>%
  filter(annual_inc <= 300000)

lbls <- c('0-20K','20-40K','40-60K','60-80K','80-100K','100-120K','120-140K','140-160K','160-180K','180-200K', '200-220K', '220-240K', '240-260K', '260-280K', '280-300K')
groupedData <- filteredLendingClubData %>% 
     group_by(incomeGroup = cut(annual_inc, breaks= seq(0, 300000, by = 20000), right = TRUE, include.lowest = TRUE, labels = lbls) ) %>% 
     summarise(averageInterest= mean(int_rate), averageLoanLoanFundedAmount = mean(funded_amnt)) 

ggplot(data =groupedData, aes(x=incomeGroup, y=averageLoanLoanFundedAmount)) +
  geom_point(colour="steelblue", shape=16, aes(size=averageInterest)) +
  geom_smooth(aes(incomeGroup, averageLoanLoanFundedAmount, group = 1), method = "lm") +
  scale_y_continuous(labels = scales::dollar) +
  labs(x="Annual Income ($)",y="Average loan funded amount",title="Relation between Funded Amt, Income and Interest Rate")+
  guides(size=guide_legend("Avg \nInterest Rate (%)")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle =50, hjust=0.75))+
  theme(legend.background = element_rect())
```



```{r}

fullStateNames <- read.csv("data/states.csv")
fundedAmountByState <- lendingClubLoanData %>% 
  group_by(addr_state)%>%
  summarise(totalFundedAmount= sum(as.numeric(funded_amnt)))

fundedAmountByState <- fundedAmountByState %>%
  inner_join(fullStateNames, by = c("addr_state" = "abbreviation"))

states <- st_as_sf(map("state", plot = FALSE, fill = TRUE))
states2 <- states %>% left_join(fundedAmountByState, by = c("ID" = "state" ))

ggplot(data = states2) + 
  geom_sf(aes(fill = totalFundedAmount)) +
  scale_fill_viridis_c("Loan Funded Amount", labels = scales::dollar) +
  labs(title = "Loans Funded amount by state") +
  theme_minimal()
```

























