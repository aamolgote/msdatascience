---
title: "Capstone Project - Week1"
author: "Amol Gote"
date: "11/7/2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library_setup, MESSAGE = FALSE, warning=FALSE}
set.seed(123)
library(tidyverse)
library(caret)
```


```{r load_data, MESSAGE = FALSE, warning=FALSE}
fundamentals_ds <- read.csv("./data/Fundamentals_DS.csv", na.strings=c(""," "))
nrow(fundamentals_ds)
```



```{r filter_data_datafmt, MESSAGE = FALSE, warning=FALSE}
names(fundamentals_ds)[names(fundamentals_ds) == "Ã¯..gvkey"] <- "gvkey"
fundamentals_ds_filter <- fundamentals_ds %>%
  filter(datafmt == 'STD') 
nrow(fundamentals_ds_filter)
```

```{r remove_cols_with_high_na, MESSAGE = FALSE, warning=FALSE}
fundamentals_ds_filter_1 <- fundamentals_ds_filter[ lapply( fundamentals_ds_filter, function(x) sum(is.na(x)) / length(x) ) < 0.1 ]
ncol(fundamentals_ds_filter_1)
```

```{r write_file, MESSAGE = FALSE, warning=FALSE}
write.csv(fundamentals_ds_filter_1, file = "data/fundamentals_ds_filter_1.csv", row.names=FALSE)
```

```{r write_filter_after_na_removal, MESSAGE = FALSE, warning=FALSE}
fundamentals_ds_filter_1 <- fundamentals_ds_filter_1[ lapply( fundamentals_ds_filter_1, function(x) sum(is.na(x)) / length(x) ) < 0.1 ]
fundamentals_ds_filter_1 <- subset(fundamentals_ds_filter_1, select = -c(datadate,indfmt,curncd,consol,popsrc,conm,curcd,apdedate,fdate,add1,addzip,busdesc,
                                                                         city,conml,weburl,phone,loc,final,fyr,acchg,fic,
                                                                         xido,xidoc,naicsh,sich,au,auop,auopic,fyrc,ggroup,gind,gsector,gsubind,priusa))
write.csv(fundamentals_ds_filter_1, file = "data/fundamentals_ds_filter_2.csv", row.names=FALSE, na="")
```

```{r identify_near_zero_variance, MESSAGE = FALSE, warning=FALSE}
nzv_ds <- nearZeroVar(fundamentals_ds_filter_1, saveMetrics = TRUE)
nzv_ds <- nzv_ds[nzv_ds[,"nzv"] > 0, ]
nzv_ds
```



```{r remove_near_zero_variance_columns, MESSAGE = FALSE, warning=FALSE}
nzv_ds_cols <- nearZeroVar(fundamentals_ds_filter_1)
fundamentals_ds_filter_1 <- fundamentals_ds_filter_1[, -nzv_ds_cols]
write.csv(fundamentals_ds_filter_1, file = "data/fundamentals_ds_filter_3.csv", row.names=FALSE, na="")
```

```{r, column_count_after_nzv_removal, MESSAGE = FALSE}
ncol(fundamentals_ds_filter_1)
```


```{r remove_not_required_variables, MESSAGE = FALSE, warning=FALSE }
fundamentals_ds_filter_1 <- subset(fundamentals_ds_filter_1, select = -c(acctstd,ismod,src,acodo,acox,
                                                                          aox,capxv,ceql,cibegni,cicurr,cidergl,
                                                                          cimii,cipen,cisecgl,citotal,cshfd,cshpri,dclo,dcpstk,
                                                                          dltis,dlto,dltr,do,dp,dpvieb,drc,
                                                                          drlt,dv,dvc,epsfx,epspx,exre,
                                                                          fopox,ibadj,ibc,ibcom,ibmii,
                                                                          invch,ivaco,ivaeq,ivao,lco,
                                                                          lcox,lcoxdr,lct,loxdr,mibn,
                                                                          mibt,mii,msa,niadj,np,oprepsx,pnca,ppent,ppeveb,
                                                                          recco,rectr,sale,spced,spceeps,
                                                                          tstkc,txbco,txbcof,txdb,
                                                                          txdba,txdbca,txdc,txdi,
                                                                          txditc,txndb,xopr,exchg,costat,
                                                                          ceoso,cfoso,idbflag,naics,sic,stko))
write.csv(fundamentals_ds_filter_1, file = "data/fundamentals_ds_filter_4.csv", row.names=FALSE, na="")
```

```{r column_count_after_col_removal, MESSAGE = FALSE, warning=FALSE}
ncol(fundamentals_ds_filter_1)
fundamentals_ds_filter_1
```



```{r filter_data_re_stmt, MESSAGE = FALSE, warning=FALSE}
fundamentals_restmt_ds_filter <- fundamentals_ds %>%
  filter(datafmt == 'SUMM_STD')
std_cols <- colnames(fundamentals_ds_filter_1)
fundamentals_restmt_ds_filter <- subset(fundamentals_restmt_ds_filter, select = c(std_cols))
fundamentals_restmt_ds_filter <- fundamentals_restmt_ds_filter[ lapply( fundamentals_restmt_ds_filter, function(x) sum(is.na(x)) / length(x) ) < 0.1 ]
head(fundamentals_restmt_ds_filter)
#summary(fundamentals_restmt_ds_filter)
```

```{r compare_restatement_rows, MESSAGE = FALSE, warning=FALSE}

sample_restmt_ds_filter <- fundamentals_restmt_ds_filter #%>%
  #filter(gvkey == 16505)
sample_ds_filter <- fundamentals_ds_filter_1 #%>%
  #filter(gvkey == 16505)
nrow(sample_restmt_ds_filter)
nrow(sample_ds_filter)

fundamentals_ds_filter_1$restmt_at <- 0
fundamentals_ds_filter_1$restmt_at_mag <- 0.0

fundamentals_ds_filter_1$restmt_capx <- 0
fundamentals_ds_filter_1$restmt_capx_mag <- 0.0

fundamentals_ds_filter_1$restmt_cogs <- 0
fundamentals_ds_filter_1$restmt_cogs_mag <- 0.0

fundamentals_ds_filter_1$restmt_dltt <- 0
fundamentals_ds_filter_1$restmt_dltt_mag <- 0.0

fundamentals_ds_filter_1$restmt_epsfi <- 0
fundamentals_ds_filter_1$restmt_epsfi_mag <- 0.0

fundamentals_ds_filter_1$restmt_epspi <- 0
fundamentals_ds_filter_1$restmt_epspi_mag <- 0.0

fundamentals_ds_filter_1$restmt_ib <- 0
fundamentals_ds_filter_1$restmt_ib_mag <- 0.0

fundamentals_ds_filter_1$restmt_ni <- 0
fundamentals_ds_filter_1$restmt_ni_mag <- 0.0

fundamentals_ds_filter_1$restmt_nopi <- 0
fundamentals_ds_filter_1$restmt_nopi_mag <- 0.0

fundamentals_ds_filter_1$restmt_pi <- 0
fundamentals_ds_filter_1$restmt_pi_mag <- 0.0

fundamentals_ds_filter_1$restmt_reuna <- 0
fundamentals_ds_filter_1$restmt_reuna_mag <- 0.0

fundamentals_ds_filter_1$restmt_seq <- 0
fundamentals_ds_filter_1$restmt_seq_mag <- 0.0

fundamentals_ds_filter_1$restmt_teq <- 0
fundamentals_ds_filter_1$restmt_teq_mag <- 0.0

fundamentals_ds_filter_1$restmt_txt <- 0
fundamentals_ds_filter_1$restmt_txt_mag <- 0.0

fundamentals_ds_filter_1$restmt_wcap <- 0
fundamentals_ds_filter_1$restmt_wcap_mag <- 0.0

for (row in 1:nrow(sample_restmt_ds_filter)){
  restmt_item_gvkey  <- sample_restmt_ds_filter[row, "gvkey"]
  restmt_item_gvkey
  restmt_item_fyear  <- sample_restmt_ds_filter[row, "fyear"]
  restmt_item_at  <- sample_restmt_ds_filter[row, "at"]
  restmt_item_capx  <- sample_restmt_ds_filter[row, "capx"]
  restmt_item_cogs  <- sample_restmt_ds_filter[row, "cogs"]
  restmt_item_dltt  <- sample_restmt_ds_filter[row, "dltt"]
  restmt_item_epsfi  <- sample_restmt_ds_filter[row, "epsfi"]
  restmt_item_epspi  <- sample_restmt_ds_filter[row, "epspi"]
  
  restmt_item_ib  <- sample_restmt_ds_filter[row, "ib"]
  restmt_item_ni  <- sample_restmt_ds_filter[row, "ni"]
  restmt_item_nopi  <- sample_restmt_ds_filter[row, "nopi"]
  restmt_item_pi  <- sample_restmt_ds_filter[row, "pi"]
  restmt_item_reuna  <- sample_restmt_ds_filter[row, "reuna"]
  restmt_item_seq  <- sample_restmt_ds_filter[row, "seq"]
  restmt_item_teq  <- sample_restmt_ds_filter[row, "teq"]
  restmt_item_txt  <- sample_restmt_ds_filter[row, "txt"]
  restmt_item_wcap  <- sample_restmt_ds_filter[row, "wcap"]
  
  
  row_count <- as.integer(nrow(subset(fundamentals_ds_filter_1, gvkey == restmt_item_gvkey & fyear == restmt_item_fyear)))
  
  if (row_count > 0){
    fundamental_stmt_row <- fundamentals_ds_filter_1 %>%
       filter(gvkey == restmt_item_gvkey & fyear == restmt_item_fyear)

    stmt_item_gvkey  <- fundamental_stmt_row["gvkey"]
    stmt_item_fyear  <- fundamental_stmt_row["fyear"]
    stmt_item_at  <- fundamental_stmt_row["at"]
    stmt_item_capx  <- fundamental_stmt_row["capx"]
    stmt_item_cogs  <- fundamental_stmt_row["cogs"]
    stmt_item_dltt  <- fundamental_stmt_row["dltt"]
    stmt_item_epsfi  <- fundamental_stmt_row["epsfi"]
    stmt_item_epspi  <- fundamental_stmt_row["epspi"]
    stmt_item_ib  <- fundamental_stmt_row["ib"]
    stmt_item_ni  <- fundamental_stmt_row["ni"]
    stmt_item_nopi  <- fundamental_stmt_row["nopi"]
    stmt_item_pi  <- fundamental_stmt_row["pi"]
    stmt_item_reuna  <- fundamental_stmt_row["reuna"]
    stmt_item_seq  <- fundamental_stmt_row["seq"]
    stmt_item_teq  <- fundamental_stmt_row["teq"]
    stmt_item_txt  <- fundamental_stmt_row["txt"]
    stmt_item_wcap  <- fundamental_stmt_row["wcap"]
  
  
    if (!is.na(restmt_item_at) & !is.na(stmt_item_at) & restmt_item_at != stmt_item_at){
      fundamentals_ds_filter_1$restmt_at[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_at - stmt_item_at)/stmt_item_at) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_at_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    if (!is.na(restmt_item_capx) & !is.na(stmt_item_capx) & restmt_item_capx != stmt_item_capx){
      fundamentals_ds_filter_1$restmt_capx[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_capx - stmt_item_capx)/stmt_item_capx) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_capx_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    if (!is.na(restmt_item_cogs) & !is.na(stmt_item_cogs) & restmt_item_cogs != stmt_item_cogs){
      fundamentals_ds_filter_1$restmt_cogs[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_cogs - stmt_item_cogs)/stmt_item_cogs) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_cogs_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    if (!is.na(restmt_item_dltt) & !is.na(stmt_item_dltt) & restmt_item_dltt != stmt_item_dltt){
      fundamentals_ds_filter_1$restmt_dltt[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_dltt - stmt_item_dltt)/stmt_item_dltt) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_dltt_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    if (!is.na(restmt_item_epsfi) & !is.na(stmt_item_epsfi) & restmt_item_epsfi != stmt_item_epsfi){
      fundamentals_ds_filter_1$restmt_epsfi[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_epsfi - stmt_item_epsfi)/stmt_item_epsfi) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_epsfi_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    if (!is.na(restmt_item_epspi) & !is.na(stmt_item_epspi) & restmt_item_epspi != stmt_item_epspi){
      fundamentals_ds_filter_1$restmt_epspi[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_epspi - stmt_item_epspi)/stmt_item_epspi) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_epspi_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    
    if (!is.na(restmt_item_ib) & !is.na(stmt_item_ib) & restmt_item_ib != stmt_item_ib){
      fundamentals_ds_filter_1$restmt_ib[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_ib - stmt_item_ib)/stmt_item_ib) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_ib_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    if (!is.na(restmt_item_ni) & !is.na(stmt_item_ni) & restmt_item_ni != stmt_item_ni){
      fundamentals_ds_filter_1$restmt_ni[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_ni - stmt_item_ni)/stmt_item_ni) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_ni_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    if (!is.na(restmt_item_nopi) & !is.na(stmt_item_nopi) & restmt_item_nopi != stmt_item_nopi){
      fundamentals_ds_filter_1$restmt_nopi[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_nopi - stmt_item_nopi)/stmt_item_nopi) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_nopi_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    if (!is.na(restmt_item_pi) & !is.na(stmt_item_pi) & restmt_item_pi != stmt_item_pi){
      fundamentals_ds_filter_1$restmt_pi[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_pi - stmt_item_pi)/stmt_item_pi) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_pi_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    if (!is.na(restmt_item_reuna) & !is.na(stmt_item_reuna) & restmt_item_reuna != stmt_item_reuna){
      fundamentals_ds_filter_1$restmt_reuna[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_reuna - stmt_item_reuna)/stmt_item_reuna) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_reuna_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    if (!is.na(restmt_item_seq) & !is.na(stmt_item_seq) & restmt_item_seq != stmt_item_seq){
      fundamentals_ds_filter_1$restmt_seq[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_seq - stmt_item_seq)/stmt_item_seq) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_seq_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    if (!is.na(restmt_item_teq) & !is.na(stmt_item_teq) & restmt_item_teq != stmt_item_teq){
      fundamentals_ds_filter_1$restmt_teq[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_teq - stmt_item_teq)/stmt_item_teq) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_teq_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    if (!is.na(restmt_item_txt) & !is.na(stmt_item_txt) & restmt_item_txt != stmt_item_txt){
      fundamentals_ds_filter_1$restmt_txt[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_txt - stmt_item_txt)/stmt_item_txt) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_txt_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
    
    if (!is.na(restmt_item_wcap) & !is.na(stmt_item_wcap) & restmt_item_wcap != stmt_item_wcap){
      fundamentals_ds_filter_1$restmt_wcap[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- 1
      magnitude  <- ((restmt_item_wcap - stmt_item_wcap)/stmt_item_wcap) * 100.0
      magnitude  <- as.double(round(magnitude, digits = 3))
      fundamentals_ds_filter_1$restmt_wcap_mag[fundamentals_ds_filter_1$gvkey == restmt_item_gvkey & fundamentals_ds_filter_1$fyear == restmt_item_fyear] <- magnitude
    }
  }
}
head(fundamentals_ds_filter_1)
```